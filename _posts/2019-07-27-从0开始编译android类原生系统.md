#从0开始编译android类原生系统
﻿写在文章开头的废话：
﻿
﻿**为什么我要写这篇文章**
> 给自己留下笔记，给大家一起进步。

﻿**为什么原生安卓？**
> 原生，即是AOSP，是不包括厂商或运营商定制程序以及任何第三方修改的Android系统，主要由谷歌维护。所以说原生安卓会很干净。不会有系统应用偷偷联网，偷偷窃取用户信息。而且还少了很多应用，内存也大了起来。

﻿**为什么这么多的原生安卓系统，还有不同日期版本？**
> 在各类美化和修改团队下，产生了各种类型的系统，例如著名的CM(LineageOS),Crdroid,havoc,dotos.他们都是为了原生更加好看，好用而存在的。每个月，因为谷歌都会定期给AOSP进行安全更新，所以原生系统会很安全。

﻿**我应该选择哪一个？**
> 你应该跟上你所选的系统，跟上自己喜欢的开发者脚步，刷上最新的系统。


----------

**环境准备**

> 在 Ubuntu 18.04 下编译 LineageOS/CM 等 AOSP
> 源码可能会踩到很多坑。下面就跟我一起来配置避免入坑吧。
> Ubuntu 18.04 LTS 请选择 64 位的。

**硬件最低要求：**
>  HDD: HDD 100GB 及以上剩余存储空间(最好用固态硬盘)。
>  CPU 性能差点没事，只不过是浪费时间与电费而已。（本人是AMD Ryzen 2500u）
>  安卓源码所在目录最低剩余空间不要小于 150GB。

本人建议：
胆子大去学校机房编译，系统十分钟就出来了2333

----------

 - **安装依赖组件**（编译需要用到的东西，复制就完事了）

    `sudo apt install -y bc bison build-essential curl flex gcc-multilib git git-core gnupg gperf g++-multilib libesd0-dev libgl1-mesa-dev liblz4-tool libncurses5-dev libreadline6-dev \`
    
    `sudo apt install libsdl1.2-dev libwxgtk3.0-dev libxml2 libxml2-utils libx11-dev lib32ncurses5-dev lib32z1-dev lzop pngcrush schedtool squashfs-tools \`

    `sudo apt install unzip xsltproc zip zlib1g-dev \`
    
    `sudo apt install python git \`

> 如果显示libxml2-utils_2.9.4-1+deb.sury.org~xenial+2_amd64.deb 找不到，无法直接安装。解决方法
直接google搜索 libxml2-utils_2.9.4-1+deb.sury.org~xenial+2_amd64.deb，下载对应的deb文件。

 - **安装 JDK**

    `sudo apt install software-properties-common`
    
    `sudo add-apt-repository ppa:openjdk-r/ppa`
    
    `sudo apt update`
    
    `sudo apt install -y openjdk-8-jdk`

 - **设置repo工具**（如果这里不行，其实清华，中科大的源也是可以的。）
参考教程：[谷歌下载源代码教程][1]，[中科大aosp下载教程][2]

> 将 https://mirrors.tuna.tsinghua.edu.cn/git/git-repo 替换为 git://mirrors.ustc.edu.cn/aosp/platform/manifest。就是中科大的源啦
> 
> repo的运行过程中会尝试访问官方的git源更新自己，如果想使用tuna的镜像源进行更新，可以将如下内容复制到你的~/.bashrc里：`export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/`
    
`curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo > ~/bin/repo`

`chmod a+x ~/bin/repo`

`echo "export PATH=~/bin:$PATH" >> ~/.bashrc`

`source ~/.bashrc`

 - **设置git身份，添加自己的邮箱和姓名：**

    `git config --global user.email "piratemorgen@gmail.com"`
    `git config --global user.name "piratemorgen"`

 - **初始化repo客户端：**新建目录（别起太长或中文，你会后悔的）

    `mkdir -p ~/dotos`
    `cd ~/dotos`

> 当然，他是一个莫滴感情的工具，我们这里将下载aosp编译dotos系统，所以命名dotos

 - **初始化仓库**（直接在github下载也行，放进dotos在运行以下命令）[manifest.zip][3]

    `repo init -u git://github.com/DotOS/manifest.git -b dot-p`

> 你要做LineageOS16,或者下载完整的AOSP，可以根据主页的设置repo init(当前版本为r45)
>`repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b android-9.0.0_r45`
> 这里可以换成清华源，我用的是中科大
> 
> 如果提示无法连接到 gerrit.googlesource.com，可以编辑 ~/bin/repo，把 REPO_URL 一行替换成下面的：
> REPO_URL = 'https://gerrit-googlesource.proxy.ustclug.org/git-repo'
>
> 替换已有的AOSP源代码的remote
> 如果你之前已经通过某种途径获得了AOSP的源码，但是你希望以后通过中科大同步，只需要将.repo/manifest.xml（隐藏文件夹）中的
> 
>    `<remote  name="aosp"
>     fetch=".."
>     review="https://android-review.googlesource.com/" />`
> 
> 改为下面的code即可：
> 
>    `<remote  name="aosp"
>     fetch="git://mirrors.ustc.edu.cn/aosp/"
>     review="https://android-review.googlesource.com/" />`

 - **下载AOSP仓库**

    `repo sync -c -jx --force-sync --no-clone-bundle --no-tags`

> `-jx`指的是你的下载线程，太多会卡，太少会慢
源码下载完成后，看到下面的信息可以说明下载成功。整个源码的大小为45g


----------


 - **构建手机内核**（这里以小米9se为例）**重要：内核开发者工作**

> 手机内核有新有旧，当然，这里为了方便开发者，我决定挑选小米初始的内核，并且自己重做（重新打caf等操作）
手机内核是决定硬件是否能正常工作的部分，很重要。

要在内核上工作的内容差不多，就是打commit，保持上游更新，如果你需要做成offical，不能乱来，请看[教程][4]打上游
Git是一个 “分布式版本管理工具”，我们这里需要学习git工具的知识：[git-tips][5]

打开终端，我喜欢在主页面下载内核/home/gah0，所以，你也可以选择你喜欢的位置克隆

`git clone -b grus-p-oss --single-branch git@github.com:Gah0/android_xiaomi_kernel_grus.git`

克隆后，进入内核文件夹内，在本地新建一个分支，自己重做内核

`cd android_xiaomi_kernel_grus` 

`git checkout -b lineage-16.0` 

成功的消息是：

> 切换到一个新分支 'lineage-16.0'

**注意:**

> 通常，我们得到的内核可能是不完整的，厂商只是遵循[gpl-2.0][6]规定释放内核快照（遵守规则），例如wifi驱动，指纹驱动，这些是其他厂商工作（手机厂商是没有义务公布出来的）。通常不会集成在内核里面，编译的时候会有各种报错。所以这个时候我们就要自己整合到内核里面...



----------

 -如何写device tree


----------



 
 


  [1]: https://source.android.com/source/downloading.html
  [2]: https://lug.ustc.edu.cn/wiki/mirrors/help/aosp
  [3]: https://github.com/DotOS/manifest
  [4]: https://github.com/android-linux-stable/notes
  [5]: https://github.com/521xueweihan/git-tips
  [6]: https://directory.fsf.org/wiki/License:GPL-2.0